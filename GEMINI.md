> **AI Agent 使用說明**
> **文件目的**：本文件旨在幫助 AI Agent 快速理解此專案的架構與運作方式，以便進行有效的維護、除錯與功能開發。
> **優先事項**：在進行任何修改前，請務必優先閱讀並理解以下三個核心部分，以確保變更符合專案設計：
> 1.  **專案結構**：了解各模組的用途與彼此的關聯。
> 2.  **模組與類別設計**：掌握核心類別的職責。
> 3.  **運作原理**：特別是 GUI 互動邏輯與背景排程的執行流程。

# Lieta Research 自動化工具架構說明
> **目的**
> 透過 GUI 讓非程式人員一次輸入多個 Ticker，批次呼叫 Lieta Research Web 平台下載各種量化模型（Gamma／Term／Smile／TV Code）結果，並依模型與時間戳自動整理檔案後搬移至指定資料夾。**核心功能：支援每日自動排程執行。**

## 1. 專案結構 (模組化)

應用程式已重構為一個高度模組化的 Python 套件，以提高可維護性、擴充性和穩定性。

```
/
├── lieta_automator/
│   ├── __init__.py           # 將資料夾標示為 Python 套件
│   ├── main.py               # 應用程式主邏輯進入點
│   ├── gui.py                # 包含 TickerApp 類別，處理使用者介面
│   ├── scraper.py            # 包含 LietaScraper 類別，處理網頁自動化
│   ├── scheduler.py          # 處理 Windows 工作排程器互動
│   ├── chrome_launcher.py    # 處理啟動與檢查偵錯模式的 Chrome
│   ├── logger.py             # 設定日誌系統 (GUI + 檔案)
│   ├── settings.py           # 處理使用者設定的載入與儲存
│   └── config.py             # 存儲所有應用程式靜態設定值
│
├── .gitignore                # 告訴 Git 忽略哪些檔案
├── requirements.txt          # 列出所有必要的 Python 套件
├── run.py                    # **打包與執行的主要入口點**
├── user_settings.json        # 儲存使用者的偏好設定 (自動生成, 已被 gitignore)
├── log.jsonl                 # 結構化的日誌輸出檔案 (自動生成, 已被 gitignore)
└── 啟動偵錯模式Chrome.lnk    # 快速啟動 Chrome 的捷徑 (已被 gitignore)
```

## 2. 安裝與執行

### 2.1. 安裝依賴套件
在終端機中執行以下指令，安裝所有必要的函式庫：
```bash
pip install -r requirements.txt
```

| 類別 | 套件 | 用途 |
| --- | --- | --- |
| Web 自動化 | `selenium` | 控制 Chrome 瀏覽器、互動、下載檔案。 |
| GUI | `tkinter` | **Python 內建**，無需安裝。用於建立視覺化操作介面。 |
| Windows 捷徑 | `winshell` | 用於建立和管理 Windows 捷徑檔案。 |
| 系統 | `os`, `shutil`, `subprocess` | **Python 內建**。用於檔案與系統操作。 |

### 2.2. 執行程式
使用以下指令從專案根目錄啟動應用程式：
```bash
python run.py
```
程式啟動時會自動檢查 Chrome 是否以偵錯模式執行，並提供指引。

### 2.3. 執行權限 (重要)
- **一般使用**：直接執行 `python run.py` 即可。
- **設定自動排程**：若要使用「自動排程」功能，**必須以系統管理員身分執行程式**。方法是在 `run.py` 或其捷徑上按右鍵，選擇「以系統管理員身分執行」。這是因為程式需要權限去修改 Windows 的系統排程設定。

---

## 3. 模組與類別設計

| 模組 | 類別/函式 | 關鍵職責 |
| --- | --- | --- |
| `run.py` | (無類別) | - **應用程式主入口點**。
- 呼叫 `lieta_automator.main` 來啟動程式。 |
| `main.py` | `main()` | - **判斷執行模式**：檢查是否有 `--run-automated` 參數。
- 若無參數，則啟動 GUI。
- 若有參數，則執行**無介面**的背景自動化任務。 |
| `gui.py` | `TickerApp` | - 建立所有 GUI 元件，處理使用者互動。
- **啟動邏輯**：「開始自動化」按鈕永遠可點擊。點擊後，程式會驗證輸入（Ticker 檔案、模型、儲存路徑），若驗證失敗則中止並在日誌區顯示錯誤。
- **排程設定介面**：在設定視窗中提供啟用、設定時間的選項。儲存設定時，直接將成功或失敗訊息寫入主介面的日誌區，**不會彈出提示視窗**。
- 在獨立執行緒中啟動 `LietaScraper`，防止介面凍結。 |
| `scraper.py` | `LietaScraper` | - 附掛到已在偵錯模式下執行的 Chrome。
- **檢查登入狀態**。
- **執行 Selenium 操作**：包含切換模型、輸入 Ticker、點擊下載。
- **智慧等待**與檔案處理邏輯。 |
| `scheduler.py` | (函式) | - **封裝 Windows 工作排程器互動**。
- 使用 `schtasks.exe` 命令列工具來**建立、更新、查詢、刪除**排程。
- 提供檢查系統管理員權限的函式。 |
| `chrome_launcher.py` | (函式) | - 自動尋找 Chrome 安裝路徑。
- 建立/更新用於啟動偵錯模式的 `.lnk` 捷徑。
- 檢查偵錯埠是否被占用。 |
| `logger.py` | `logger` | - 設定全域日誌記錄器，檔名固定為 `log.jsonl`。
- **雙重輸出**：同時將日誌寫入 GUI 和 `log.jsonl` 檔案。 |
| `settings.py` | (函式) | - 從 `user_settings.json` 載入/儲存使用者設定。
- **支援排程相關設定** (是否啟用、執行時間)。 |
| `config.py` | (無類別) | - **動態路徑管理** (`BASE_DIR`)。
- 集中管理所有**靜態**設定，如 URL、埠號、**排程任務名稱**。 |

---

## 4. 自動排程功能

新加入的自動排程功能，旨在實現「設定後不理」的全自動化操作。

### 4.1. 運作原理
此功能的核心是將「排程」的責任交給最可靠的 **Windows 工作排程器**，而我們的 Python 程式僅負責「執行任務」。

1.  **設定階段 (GUI)**：使用者在 GUI 介面中啟用排程並設定時間。此操作需要**系統管理員權限**。
2.  **寫入系統 (scheduler.py)**：程式呼叫 Windows 內建的 `schtasks.exe` 工具，建立一個名為 `LietaAutomatorDailyRun` 的每日排程任務。
3.  **觸發執行 (Windows)**：到了指定時間，Windows 會自動執行一個命令，例如：
    ```
    C:\path\to\python.exe C:\projects\Auto_Lieta_Scratch\run.py --run-automated
    ```
4.  **背景執行 (main.py)**：`run.py` 啟動時偵測到 `--run-automated` 這個特殊參數，於是**不會啟動任何 GUI 介面**。相反地，它會直接進入無頭的自動化模式，讀取 `user_settings.json` 中的設定（Ticker 檔案、模型、儲存路徑），執行所有抓取任務，並將進度記錄到 `log.jsonl` 檔案中，完成後自動退出。

### 4.2. 使用方法
1.  **以系統管理員身分執行**：在 `run.py` 或打包後的 `.exe` 上按右鍵，選擇「以系統管理員身分執行」。
2.  **開啟設定**：點擊程式主介面右上角的「齒輪」圖示。
3.  **啟用與設定時間**：
    - 勾選「啟用每日自動執行」。
    - 在下方的下拉選單中，選擇希望任務執行的「時」與「分」（24 小時制）。
4.  **儲存設定**：點擊「儲存並關閉」。程式會嘗試設定系統排程，並將執行結果（成功或失敗）顯示在主畫面的日誌區。

---
*（文件的其餘部分保持不變）*